<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons.css">
    <base target="_top">
    <style>
      input { 
        display: block; 
        margin: 5px 0;
        width: 100%;
      }
      #login { 
        display: block;
        font-size:18px;
        line-height:20px;
        margin-top:10px;
      }
    </style>
  </head>
  <body>
    <p>Enter you Canvas url</p>
    <div id="current">Current: <b><?!= PropertiesService.getDocumentProperties().getProperty("base"); ?></b></div>
    <input id="base" value="" placeholder="https://yourinstitute.instructure.com" />
    <button onclick="validateText(document.getElementById('base').value)">Set URL</button>
    <button onclick="google.script.run.withSuccessHandler(showMsg).clearBaseUrl(); document.getElementById('login').innerHTML=''">Clear current URL</button>
    <div id="result"></div>
    <div id="login"></div>
    <script>
      window.onload = function() {
        showLoginButton()
      }
      
      function showMsg(msg) {
        var result = document.getElementById('result');
        result.innerHTML = msg;
      }
      
      function showLoginButton(url) {
        var base = "<?= PropertiesService.getDocumentProperties().getProperty('base'); ?>"
        
        console.log(base);
                
        var result = document.getElementById('result');
        var login = document.getElementById('login');
        
        if(!base) {
          login.innerHTML = '';
        } else {
          var btn = document.createElement('a');
          
          if(!url) {
            url = "<?!= getAuthorizationUrl(); ?>"
          }
          
          btn.setAttribute("href",url);
          
          btn.target = "blank";
          btn.innerHTML = "Login";
  
          login.appendChild(btn);
        }
      }
      
      function validateText(url) {
      console.log(url)
      console.log(url.indexOf("http://"), url.indexOf("https://"));
        if (url.indexOf("http://") == 0 || url.indexOf("https://") == 0) {
          console.log("Setting URL...")
          google.script.run.withSuccessHandler(showLoginButton).setBaseUrl(url);
        } else {
          console.log("Adding protocol and setting URL...");
          google.script.run.withSuccessHandler(showLoginButton).setBaseUrl("https://" + url);
        }
      }
      
    </script>
  </body>
</html>


